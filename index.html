<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>Pomodoro Tracker</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="index.css">

</head>

<body>
	<div class= "header">
		<div class="container">
			<div class="row">
				<div class="col text-center">
					<div class="btn-group" role="group" aria-label="Timers">
						<button type="button" class="btn btn-secondary" id = "pomodoro-btn">Pomodoro</button>
						<button type="button" class="btn btn-secondary" id = "short-break-btn">Short Break</button>
						<button type="button" class="btn btn-secondary" id = "long-break-btn">Long Break</button>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col text-center">
					<h1 class = "timer">25:00</h1>
				</div>
			</div>

			<div class="row">
				<div class="col text-center">
					<button type="button" class="btn btn-outline-success" id = "start-btn"> Start </button>
					<button type="button" class="btn btn-outline-danger" id = "stop-btn"> Stop </button>
					<button type="button" class="btn btn-outline-dark" id = "reset-btn"> Reset </button>
				</div>
			</div>
		</div>
	</div>

	<div class = "container">
		<div class = "row"> 
			<div class = "col">
				<h1  class = "tasks-header"> Tasks </h1>
				<button type="button" class="btn btn-outline-primary" id = "add-task-btn"> Add Task</button>
			</div>
		</div>
	</div>

	<div class = "container">
		<div class = "row"> 
			<div class = "col text-center">
				<table id = "tasks">
					<tr>
						<td class = "task-options-col"></td>
						<th class = "task-col">Task</th>
						<th class = "timespent-col">Time Spent</th>
					</tr>
				</table>
			</div>
			
		</div>
	</div>
	

	<div class = "container">
		<div class = "row"> 
			<div class = "col">
				<h1> Completed </h1>
			</div>
		</div>
	</div>

	<div class = "container">
		<div class = "row"> 
			<div class = "col text-center">
				<table id= "completed">
					<tr>
						<td class = "task-options-col"></td>
						<th class = "task-col">Task</th>
						<th class = "timespent-col">Time Spent</th>
					</tr>
				</table>
			</div>
			
		</div>
	</div>


</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script>
	//Constants
	var pomodoro = "25:00"
	var shortBreakTime = "05:00"
	var longBreakTime = "20:00"

	//global vars
	var current = "pomodoro"
	var timers = {
		pomodoro: pomodoro,
		shortbreak: shortBreakTime,
		longbreak: longBreakTime
	}
	var $timer = $(".timer")
	var intervalTimer;
	var $selectedTask = null

	$("#pomodoro-btn").click(() => {
		$timer.html(pomodoro)
		current = "pomodoro"
	})
	$("#short-break-btn").click(() => {
		$timer.html(shortBreakTime)
		current = "shortbreak"
	})
	$("#long-break-btn").click(() => {
		$timer.html(longBreakTime)
		current = "longbreak"
	})

	$("#start-btn").click(() => {
		if (intervalTimer || (current==="pomodoro" && !$selectedTask)) return
			console.log ($selectedTask)
		intervalTimer = setInterval(countdown, 1000)
	})

	$("#stop-btn").click(()=> {
		clearInterval(intervalTimer)
		intervalTimer = null
	})

	$("#reset-btn").click(() => {
		$timer.html(timers[current])
		clearInterval(intervalTimer)
		intervalTimer = null
	})

	$("#add-task-btn").click(() => {
		if ($(".new-task-input").length) {return;}
		var newTaskInput = "<input class = \"new-task-input\" onblur= \"blurHandler(this)\" type = \"text\">" 
		$newTask = $("<tr> <td>" + newTaskInput + "</td> <td class = \"timespent\">00:00</td> </tr> ")
		$delButton = $("<button></button>").html("&#10006").attr("onclick", "event.stopPropagation(); deleteTask(this)")
		$completeButton = $("<button></button>").html("&#10004").attr("onclick", "event.stopPropagation(); completeTask(this)")
		$editCol = $("<td></td>").append($delButton).append($completeButton)
		$newTask.prepend($editCol)
		$("#tasks").append($newTask)
		$(".new-task-input").on('keyup', function (e) {
			if (e.keyCode === 13) { //Enter
				blurHandler(e.target)
			}
		});
	})

	function countdown() {
		var timer = $timer.html()
		var min_sec = timer.split(":")
		var min = parseInt(min_sec[0])
		var sec = parseInt(min_sec[1])
		sec -= 1
		if (sec < 0) {
			min -= 1
			sec = 59
		}

		var formatString = format2Digits(min) + ":" + format2Digits(sec)
		$timer.html(formatString)
		if (current === "pomodoro") {
			updateTime($selectedTask)
		}
		
	}

	function updateTime($selectedTask) {
		$timeSpent = $selectedTask.children(".timespent")
		timeSpent = $timeSpent.html()
		min_sec = timeSpent.split(":")
		min = parseInt(min_sec[0])
		sec = parseInt(min_sec[1])
		sec += 1
		$timeSpent.html(formatTime(min, sec))

	}

	function blurHandler(el) {
		if ($(el).val().length > 0) {
			$(el).prop("onblur", null) // To prevent error from refiring when element is removed
			$(el).parent().parent().attr('onclick','selectTask(this)');
			$(el).replaceWith("<p class = \"task\"> " + $(el).val() + "</p>")
		}
	}

	function selectTask(el) {
		if (intervalTimer || current !== "pomodoro") {return}

			if ($selectedTask != null){
				$selectedTask.removeClass("selected")
			}

			$(el).addClass("selected")
			$selectedTask = $(el)
		}

		function deleteTask(el) {
			$(el).parent().parent().remove()
		}

		function completeTask(el) {
			$task = $(el).parent().parent()
			$completedTask = $task.clone()
			if ($completedTask.hasClass("selected")) {
				$completedTask.removeClass("selected")
				$selectedTask = null
				console.log("here")
				console.log($selectedTask)
			}
			$completedTask.find("td").eq(0).children().remove()
			$completedTask.prop("onclick", null)
			$task.remove()
			$("#completed").append($completedTask)
		}


		function formatTime(mins, secs) {
			mins_carry = Math.floor(secs/60)
			secs_remaining = secs % 60
			mins += mins_carry
			return format2Digits(mins) + ":" + format2Digits(secs) 
		}

		function format2Digits(int) {
			if (int < 10) {
				return "0".concat(int)
			}
			return int
		} 

	</script>
	</html>