<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>Pomodoro Tracker</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="index.css">

</head>

<body>
	<div class="container">
		<div class="row">
			<div class="col text-center">
				<h1 class = "timer">25:00</h1>
			</div>
		</div>

		<div class="row">
			<div class="col text-center">
				<button type="button" class="btn btn-outline-success" id = "start-btn"> Start </button>
				<button type="button" class="btn btn-outline-danger" id = "stop-btn"> Stop </button>
				<button type="button" class="btn btn-outline-dark" id = "reset-btn"> Reset </button>
			</div>
		</div>
	</div>

	<div class = "container">
		<div class = "row"> 
			<div class = "col">
				<h1  class = "tasks-header"> Tasks </h1>
				<button type="button" class="btn btn-outline-primary" id = "add-task-btn"> Add Task</button>
			</div>
		</div>
	</div>

	<div class = "container">
		<div class = "row"> 
			<table class = "col text-center" id = "tasks">
				<tr>
					<th>Task</th>
					<th>Time Spent</th>
				</tr>
			</table>
		</div>
	</div>

	<div class = "container">
		<div class = "row"> 
			<div class = "col" id= "completed">
				<h1> Completed </h1>
			</div>
		</div>
	</div>

</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script>
	//Constants
	var pomodoro = "25:00"
	var shortBreakTime = "5:00"
	var longBreakTime = "20:00"

	//global vars
	var $timer = $(".timer")
	var intervalTimer;
	var $selectedTask = null;


	$("#start-btn").click(() => {
		console.log($selectedTask)
		if (intervalTimer || !$selectedTask) return
			intervalTimer = setInterval(countdown, 1000)
	})

	$("#stop-btn").click(()=> {
		clearInterval(intervalTimer)
		intervalTimer = null
	})

	$("#reset-btn").click(() => {
		$timer.html(pomodoro)
	})

	$("#add-task-btn").click(() => {
		if ($(".new-task-input").length) return
			var newTask = "<input class = \"new-task-input\" onblur= \"blurHandler(this)\" type = \"text\">" 
		$("#tasks").append(newTask)
		$(".new-task-input").on('keyup', function (e) {
			if (e.keyCode === 13) {
        		blurHandler(e.target)
    		}
		});
	})

	function countdown() {
		var timer = $timer.html()
		var min_sec = timer.split(":")
		var min = parseInt(min_sec[0])
		var sec = parseInt(min_sec[1])
		sec -= 1
		if (sec < 0) {
			min -= 1
			sec = 59
		}

		var formatString = format2Digits(min) + ":" + format2Digits(sec)
		console.log(formatString)
		$timer.html(formatString)
		updateTime($selectedTask)
	}

	function updateTime($selectedTask) {
		$timeSpent = $selectedTask.children(".timespent-wrapper").children(".timespent")
		timeSpent = $timeSpent.html()
		min_sec = timeSpent.split(":")
		min = parseInt(min_sec[0])
		sec = parseInt(min_sec[1])
		sec += 1
		console.log(timeSpent)
		$timeSpent.html(formatTime(min, sec))
		console.log($timeSpent.html())

	}

	//"<p class= \"task\" onclick = \"selectTask(this)\" >"  + $(el).val() + "<span class = \"timespent-wrapper\">Time Spent: <span class= \"timespent\">00:00</span> </span> <span  onclick = \"completeTask(this)\" class = \"close\">x</span> </p>"

	function blurHandler(el) {
		if ($(el).val().length > 0) {
			$(el).replaceWith("<tr> <td>" + $(el).val() + "</td> <td> 00: 00 </td> </tr>")
		}
	}

		function selectTask(el) {
			console.log("HI")
			if (intervalTimer) return

				if ($selectedTask != null){
					$selectedTask.removeClass("selected")
				}

				$(el).addClass("selected")
				$selectedTask = $(el)

		}

		function completeTask(el) {
			task = $(el).parent().html()
			$completedTask = $("<p>").html(task)
			$completedTask.children(".close").remove()
			$(el).parent().remove()
			$("#completed").append($completedTask)
		}


		function formatTime(mins, secs) {
			mins_carry = Math.floor(secs/60)
			secs_remaining = secs % 60
			mins += mins_carry
			return format2Digits(mins) + ":" + format2Digits(secs) 
		}

		function format2Digits(int) {
			if (int < 10) {
				return "0".concat(int)
			}
			return int
		} 

	</script>
	</html>